{"version":3,"sources":["../src/textcomplete.contenteditable.js"],"names":["CALLBACK_METHODS","el","document","ownerDocument","view","defaultView","selection","getSelection","forEach","method","bind","startListening","stopListening","searchResult","before","getBeforeCursor","after","getAfterCursor","replace","Array","isArray","range","getRange","selectNode","startContainer","execCommand","detach","newRange","setStart","length","collapse","rangeRects","getBoundingClientRect","docRects","body","container","Text","parentElement","left","lineHeight","top","dir","right","documentElement","clientWidth","collapsed","wholeText","substring","startOffset","_","test","navigator","userAgent","emitChangeEvent","e","code","getCode","event","emitMoveEvent","emitEnterEvent","emitEscEvent","defaultPrevented","preventDefault","addEventListener","onInput","onKeydown","removeEventListener","force","i","l","rangeCount","getRangeAt","contains","Error","activeElement","focus"],"mappings":"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","file":"textcomplete.contenteditable.js","sourcesContent":["// @flow\n\nimport Editor from \"textcomplete/lib/editor\"\nimport SearchResult from \"textcomplete/lib/search_result\"\nimport { calculateElementOffset, getLineHeightPx } from \"textcomplete/lib/utils\"\n\nconst CALLBACK_METHODS = [\"onInput\", \"onKeydown\"]\n\nexport default class extends Editor {\n  el: HTMLElement\n  selection: Selection\n\n  constructor(el: HTMLElement) {\n    super()\n    this.el = el\n    this.document = el.ownerDocument\n    this.view = this.document.defaultView\n    this.selection = this.view.getSelection()\n\n    CALLBACK_METHODS.forEach(method => {\n      ;(this: any)[method] = (this: any)[method].bind(this)\n    })\n\n    this.startListening()\n  }\n\n  destroy() {\n    super.destroy()\n    this.stopListening()\n    ;(this: any).el = null\n    return this\n  }\n\n  applySearchResult(searchResult: SearchResult) {\n    const before = this.getBeforeCursor()\n    const after = this.getAfterCursor()\n    if (before != null && after != null) {\n      const replace = searchResult.replace(before, after)\n      if (Array.isArray(replace)) {\n        const range = this.getRange()\n        range.selectNode(range.startContainer)\n        this.document.execCommand(\"insertText\", false, replace[0] + replace[1])\n        range.detach()\n        const newRange = this.getRange()\n        newRange.setStart(newRange.startContainer, replace[0].length)\n        newRange.collapse(true)\n      }\n    }\n  }\n\n  getCursorOffset() {\n    const range = this.getRange()\n    const rangeRects = range.getBoundingClientRect()\n\n    const docRects = this.document.body.getBoundingClientRect()\n    const container = range.startContainer\n    const el: HTMLElement = (container instanceof Text\n      ? container.parentElement\n      : container: any)\n\n    const left = rangeRects.left - docRects.left\n    const lineHeight = getLineHeightPx(el)\n    const top = rangeRects.top - docRects.top + lineHeight\n    return this.el.dir !== \"rtl\"\n      ? { left, lineHeight, top }\n      : { right: document.documentElement.clientWidth - left, lineHeight, top }\n  }\n\n  getBeforeCursor() {\n    const range = this.getRange()\n    if (range.collapsed && range.startContainer instanceof Text) {\n      return range.startContainer.wholeText.substring(0, range.startOffset)\n    }\n    return null\n  }\n\n  getAfterCursor() {\n    const range = this.getRange()\n    if (range.collapsed && range.startContainer instanceof Text) {\n      return range.startContainer.wholeText.substring(range.startOffset)\n    }\n    return null\n  }\n\n  /** @private */\n  onInput(_: Event) {\n    if (/^((?!chrome|android).)*safari/i.test(navigator.userAgent)) {\n      // Safari behaves much stranger than Chrome and Firefox.\n      return\n    }\n    this.emitChangeEvent()\n  }\n\n  /** @private */\n  onKeydown(e: KeyboardEvent) {\n    const code = this.getCode(e)\n    let event\n    if (code === \"UP\" || code === \"DOWN\") {\n      event = this.emitMoveEvent(code)\n    } else if (code === \"ENTER\") {\n      event = this.emitEnterEvent()\n    } else if (code === \"ESC\") {\n      event = this.emitEscEvent()\n    }\n    if (event && event.defaultPrevented) {\n      e.preventDefault()\n    }\n  }\n\n  /** @private */\n  startListening() {\n    this.el.addEventListener(\"input\", this.onInput)\n    this.el.addEventListener(\"keydown\", this.onKeydown)\n  }\n\n  /** @private */\n  stopListening() {\n    this.el.removeEventListener(\"input\", this.onInput)\n    this.el.removeEventListener(\"keydown\", this.onKeydown)\n  }\n\n  /** @private */\n  getRange(force: ?boolean): Range {\n    for (let i = 0, l = this.selection.rangeCount; i < l; i++) {\n      const range = this.selection.getRangeAt(i)\n      if (this.el.contains(range.startContainer)) {\n        return range\n      }\n    }\n    // The element is not active.\n    if (force) {\n      throw new Error(\"Unexpected\")\n    }\n    const activeElement = this.document.activeElement\n    this.el.focus()\n    const range = this.getRange(true)\n    activeElement && activeElement.focus()\n    return range\n  }\n}\n"]}
{"version":3,"sources":["../src/SignedData.js"],"names":["asn1js","SignedData","constructor","parameters","version","defaultValues","digestAlgorithms","encapContentInfo","certificates","crls","ocsps","signerInfos","fromSchema","schema","memberName","Error","compareWithDefault","memberValue","length","names","optional","Sequence","name","blockName","value","Integer","Set","Repeated","Constructed","idBlock","tagClass","tagNumber","valueBlock","asn1","compareSchema","verified","result","valueDec","Array","from","algorithm","certificateSet","slice","crl","signerInfoSchema","toSchema","encodeFlag","outputArray","push","certificateSetSchema","crlSchema","signerInfo","toJSON","_object","certificate","verify","signer","data","ArrayBuffer","trustedCerts","checkDate","Date","checkChain","extendedMode","findOrigin","findIssuer","sequence","Promise","resolve","messageDigestValue","shaAlgorithm","signerCertificate","timestampSerial","certificatePath","engine","crypto","reject","date","code","message","signatureVerified","signerCertificateVerified","sid","then","issuer","isEqual","serialNumber","all","filter","digest","Uint8Array","subjectPublicKeyInfo","subjectPublicKey","valueHex","results","entries","index","eContentType","fromBER","eContent","tstInfo","ex","genTime","byteLength","checkCA","cert","isCA","extensions","extension","extnID","parsedValue","cA","promiseResults","certificateChainValidationEngineParameters","certs","_result","certificateChainEngine","otherRevInfoFormat","otherRevInfo","verificationResult","resultMessage","error","Object","signerInfoHashAlgorithm","digestAlgorithm","algorithmId","isConstructed","contentValue","valueBeforeDecode","foundContentType","foundMessageDigest","signedAttrs","attributes","attribute","type","values","encodedValue","subtle","verifyWithPublicKey","signature","signatureAlgorithm","sign","privateKey","signerIndex","hashAlgorithm","hashAlgorithmOID","algorithmParams","Null","getSignatureParameters","toBER","view","content","signWithPrivateKey","OctetString"],"mappings":"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","file":"SignedData.js","sourcesContent":["import * as asn1js from \"asn1js\";\r\nimport { getParametersValue, utilConcatBuf, isEqualBuffer, clearProps } from \"pvutils\";\r\nimport { getCrypto, getEngine, getOIDByAlgorithm, getAlgorithmByOID } from \"./common.js\";\r\nimport AlgorithmIdentifier from \"./AlgorithmIdentifier.js\";\r\nimport EncapsulatedContentInfo from \"./EncapsulatedContentInfo.js\";\r\nimport Certificate from \"./Certificate.js\";\r\nimport CertificateRevocationList from \"./CertificateRevocationList.js\";\r\nimport OtherRevocationInfoFormat from \"./OtherRevocationInfoFormat.js\";\r\nimport SignerInfo from \"./SignerInfo.js\";\r\nimport CertificateSet from \"./CertificateSet.js\";\r\nimport RevocationInfoChoices from \"./RevocationInfoChoices.js\";\r\nimport IssuerAndSerialNumber from \"./IssuerAndSerialNumber.js\";\r\nimport TSTInfo from \"./TSTInfo.js\";\r\nimport CertificateChainValidationEngine from \"./CertificateChainValidationEngine.js\";\r\nimport BasicOCSPResponse from \"./BasicOCSPResponse.js\";\r\n//**************************************************************************************\r\n/**\r\n * Class from RFC5652\r\n */\r\nexport default class SignedData \r\n{\r\n\t//**********************************************************************************\r\n\t/**\r\n\t * Constructor for SignedData class\r\n\t * @param {Object} [parameters={}]\r\n\t * @property {Object} [schema] asn1js parsed value\r\n\t */\r\n\tconstructor(parameters = {})\r\n\t{\r\n\t\t//region Internal properties of the object\r\n\t\t/**\r\n\t\t * @type {number}\r\n\t\t * @description version\r\n\t\t */\r\n\t\tthis.version = getParametersValue(parameters, \"version\", SignedData.defaultValues(\"version\"));\r\n\t\t/**\r\n\t\t * @type {Array.<AlgorithmIdentifier>}\r\n\t\t * @description digestAlgorithms\r\n\t\t */\r\n\t\tthis.digestAlgorithms = getParametersValue(parameters, \"digestAlgorithms\", SignedData.defaultValues(\"digestAlgorithms\"));\r\n\t\t/**\r\n\t\t * @type {EncapsulatedContentInfo}\r\n\t\t * @description encapContentInfo\r\n\t\t */\r\n\t\tthis.encapContentInfo = getParametersValue(parameters, \"encapContentInfo\", SignedData.defaultValues(\"encapContentInfo\"));\r\n\t\t\r\n\t\tif(\"certificates\" in parameters)\r\n\t\t\t/**\r\n\t\t\t * @type {Array.<Certificate|OtherCertificateFormat>}\r\n\t\t\t * @description certificates\r\n\t\t\t */\r\n\t\t\tthis.certificates = getParametersValue(parameters, \"certificates\", SignedData.defaultValues(\"certificates\"));\r\n\t\t\r\n\t\tif(\"crls\" in parameters)\r\n\t\t\t/**\r\n\t\t\t * @type {Array.<CertificateRevocationList|OtherRevocationInfoFormat>}\r\n\t\t\t * @description crls\r\n\t\t\t */\r\n\t\t\tthis.crls = getParametersValue(parameters, \"crls\", SignedData.defaultValues(\"crls\"));\r\n\t\t\r\n\t\tif(\"ocsps\" in parameters)\r\n\t\t\t/**\r\n\t\t\t * @type {Array.<BasicOCSPResponse>}\r\n\t\t\t * @description crls\r\n\t\t\t */\r\n\t\t\tthis.ocsps = getParametersValue(parameters, \"ocsps\", SignedData.defaultValues(\"ocsps\"));\r\n\r\n\t\t/**\r\n\t\t * @type {Array.<SignerInfo>}\r\n\t\t * @description signerInfos\r\n\t\t */\r\n\t\tthis.signerInfos = getParametersValue(parameters, \"signerInfos\", SignedData.defaultValues(\"signerInfos\"));\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region If input argument array contains \"schema\" for this object\r\n\t\tif(\"schema\" in parameters)\r\n\t\t\tthis.fromSchema(parameters.schema);\r\n\t\t//endregion\r\n\t}\r\n\t//**********************************************************************************\r\n\t/**\r\n\t * Return default values for all class members\r\n\t * @param {string} memberName String name for a class member\r\n\t */\r\n\tstatic defaultValues(memberName)\r\n\t{\r\n\t\tswitch(memberName)\r\n\t\t{\r\n\t\t\tcase \"version\":\r\n\t\t\t\treturn 0;\r\n\t\t\tcase \"digestAlgorithms\":\r\n\t\t\t\treturn [];\r\n\t\t\tcase \"encapContentInfo\":\r\n\t\t\t\treturn new EncapsulatedContentInfo();\r\n\t\t\tcase \"certificates\":\r\n\t\t\t\treturn [];\r\n\t\t\tcase \"crls\":\r\n\t\t\t\treturn [];\r\n\t\t\tcase \"ocsps\":\r\n\t\t\t\treturn [];\r\n\t\t\tcase \"signerInfos\":\r\n\t\t\t\treturn [];\r\n\t\t\tdefault:\r\n\t\t\t\tthrow new Error(`Invalid member name for SignedData class: ${memberName}`);\r\n\t\t}\r\n\t}\r\n\t//**********************************************************************************\r\n\t/**\r\n\t * Compare values with default values for all class members\r\n\t * @param {string} memberName String name for a class member\r\n\t * @param {*} memberValue Value to compare with default value\r\n\t */\r\n\tstatic compareWithDefault(memberName, memberValue)\r\n\t{\r\n\t\tswitch(memberName)\r\n\t\t{\r\n\t\t\tcase \"version\":\r\n\t\t\t\treturn (memberValue === SignedData.defaultValues(\"version\"));\r\n\t\t\tcase \"encapContentInfo\":\r\n\t\t\t\treturn new EncapsulatedContentInfo();\r\n\t\t\tcase \"digestAlgorithms\":\r\n\t\t\tcase \"certificates\":\r\n\t\t\tcase \"crls\":\r\n\t\t\tcase \"ocsps\":\r\n\t\t\tcase \"signerInfos\":\r\n\t\t\t\treturn (memberValue.length === 0);\r\n\t\t\tdefault:\r\n\t\t\t\tthrow new Error(`Invalid member name for SignedData class: ${memberName}`);\r\n\t\t}\r\n\t}\r\n\t//**********************************************************************************\r\n\t/**\r\n\t * Return value of asn1js schema for current class\r\n\t * @param {Object} parameters Input parameters for the schema\r\n\t * @returns {Object} asn1js schema object\r\n\t */\r\n\tstatic schema(parameters = {})\r\n\t{\r\n\t\t//SignedData ::= SEQUENCE {\r\n\t\t//    version CMSVersion,\r\n\t\t//    digestAlgorithms DigestAlgorithmIdentifiers,\r\n\t\t//    encapContentInfo EncapsulatedContentInfo,\r\n\t\t//    certificates [0] IMPLICIT CertificateSet OPTIONAL,\r\n\t\t//    crls [1] IMPLICIT RevocationInfoChoices OPTIONAL,\r\n\t\t//    signerInfos SignerInfos }\r\n\t\t\r\n\t\t/**\r\n\t\t * @type {Object}\r\n\t\t * @property {string} [blockName]\r\n\t\t * @property {string} [optional]\r\n\t\t * @property {string} [digestAlgorithms]\r\n\t\t * @property {string} [encapContentInfo]\r\n\t\t * @property {string} [certificates]\r\n\t\t * @property {string} [crls]\r\n\t\t * @property {string} [signerInfos]\r\n\t\t */\r\n\t\tconst names = getParametersValue(parameters, \"names\", {});\r\n\r\n\t\tif((\"optional\" in names) === false)\r\n\t\t\tnames.optional = false;\r\n\t\t\r\n\t\treturn (new asn1js.Sequence({\r\n\t\t\tname: (names.blockName || \"SignedData\"),\r\n\t\t\toptional: names.optional,\r\n\t\t\tvalue: [\r\n\t\t\t\tnew asn1js.Integer({ name: (names.version || \"SignedData.version\") }),\r\n\t\t\t\tnew asn1js.Set({\r\n\t\t\t\t\tvalue: [\r\n\t\t\t\t\t\tnew asn1js.Repeated({\r\n\t\t\t\t\t\t\tname: (names.digestAlgorithms || \"SignedData.digestAlgorithms\"),\r\n\t\t\t\t\t\t\tvalue: AlgorithmIdentifier.schema()\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t]\r\n\t\t\t\t}),\r\n\t\t\t\tEncapsulatedContentInfo.schema(names.encapContentInfo || {\r\n\t\t\t\t\tnames: {\r\n\t\t\t\t\t\tblockName: \"SignedData.encapContentInfo\"\r\n\t\t\t\t\t}\r\n\t\t\t\t}),\r\n\t\t\t\tnew asn1js.Constructed({\r\n\t\t\t\t\tname: (names.certificates || \"SignedData.certificates\"),\r\n\t\t\t\t\toptional: true,\r\n\t\t\t\t\tidBlock: {\r\n\t\t\t\t\t\ttagClass: 3, // CONTEXT-SPECIFIC\r\n\t\t\t\t\t\ttagNumber: 0 // [0]\r\n\t\t\t\t\t},\r\n\t\t\t\t\tvalue: CertificateSet.schema().valueBlock.value\r\n\t\t\t\t}), // IMPLICIT CertificateSet\r\n\t\t\t\tnew asn1js.Constructed({\r\n\t\t\t\t\toptional: true,\r\n\t\t\t\t\tidBlock: {\r\n\t\t\t\t\t\ttagClass: 3, // CONTEXT-SPECIFIC\r\n\t\t\t\t\t\ttagNumber: 1 // [1]\r\n\t\t\t\t\t},\r\n\t\t\t\t\tvalue: RevocationInfoChoices.schema(names.crls || {\r\n\t\t\t\t\t\tnames: {\r\n\t\t\t\t\t\t\tcrls: \"SignedData.crls\"\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}).valueBlock.value\r\n\t\t\t\t}), // IMPLICIT RevocationInfoChoices\r\n\t\t\t\tnew asn1js.Set({\r\n\t\t\t\t\tvalue: [\r\n\t\t\t\t\t\tnew asn1js.Repeated({\r\n\t\t\t\t\t\t\tname: (names.signerInfos || \"SignedData.signerInfos\"),\r\n\t\t\t\t\t\t\tvalue: SignerInfo.schema()\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t]\r\n\t\t\t\t})\r\n\t\t\t]\r\n\t\t}));\r\n\t}\r\n\t//**********************************************************************************\r\n\t/**\r\n\t * Convert parsed asn1js object into current class\r\n\t * @param {!Object} schema\r\n\t */\r\n\tfromSchema(schema)\r\n\t{\r\n\t\t//region Clear input data first\r\n\t\tclearProps(schema, [\r\n\t\t\t\"SignedData.version\",\r\n\t\t\t\"SignedData.digestAlgorithms\",\r\n\t\t\t\"SignedData.encapContentInfo\",\r\n\t\t\t\"SignedData.certificates\",\r\n\t\t\t\"SignedData.crls\",\r\n\t\t\t\"SignedData.signerInfos\"\r\n\t\t]);\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region Check the schema is valid\r\n\t\tconst asn1 = asn1js.compareSchema(schema,\r\n\t\t\tschema,\r\n\t\t\tSignedData.schema()\r\n\t\t);\r\n\t\t\r\n\t\tif(asn1.verified === false)\r\n\t\t\tthrow new Error(\"Object's schema was not verified against input data for SignedData\");\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region Get internal properties from parsed schema\r\n\t\tthis.version = asn1.result[\"SignedData.version\"].valueBlock.valueDec;\r\n\t\t\r\n\t\tif(\"SignedData.digestAlgorithms\" in asn1.result) // Could be empty SET of digest algorithms\r\n\t\t\tthis.digestAlgorithms = Array.from(asn1.result[\"SignedData.digestAlgorithms\"], algorithm => new AlgorithmIdentifier({ schema: algorithm }));\r\n\t\t\r\n\t\tthis.encapContentInfo = new EncapsulatedContentInfo({ schema: asn1.result[\"SignedData.encapContentInfo\"] });\r\n\t\t\r\n\t\tif(\"SignedData.certificates\" in asn1.result)\r\n\t\t{\r\n\t\t\tconst certificateSet = new CertificateSet({\r\n\t\t\t\tschema: new asn1js.Set({\r\n\t\t\t\t\tvalue: asn1.result[\"SignedData.certificates\"].valueBlock.value\r\n\t\t\t\t})\r\n\t\t\t});\r\n\t\t\tthis.certificates = certificateSet.certificates.slice(0); // Copy all just for making comfortable access\r\n\t\t}\r\n\t\t\r\n\t\tif(\"SignedData.crls\" in asn1.result)\r\n\t\t{\r\n\t\t\tthis.crls = Array.from(asn1.result[\"SignedData.crls\"], crl =>\r\n\t\t\t{\r\n\t\t\t\tif(crl.idBlock.tagClass === 1)\r\n\t\t\t\t\treturn new CertificateRevocationList({ schema: crl });\r\n\t\t\t\t\r\n\t\t\t\t//region Create SEQUENCE from [1]\r\n\t\t\t\tcrl.idBlock.tagClass = 1; // UNIVERSAL\r\n\t\t\t\tcrl.idBlock.tagNumber = 16; // SEQUENCE\r\n\t\t\t\t//endregion\r\n\t\t\t\t\r\n\t\t\t\treturn new OtherRevocationInfoFormat({ schema: crl });\r\n\t\t\t});\r\n\t\t}\r\n\t\t\r\n\t\tif(\"SignedData.signerInfos\" in asn1.result) // Could be empty SET SignerInfos\r\n\t\t\tthis.signerInfos = Array.from(asn1.result[\"SignedData.signerInfos\"], signerInfoSchema => new SignerInfo({ schema: signerInfoSchema }));\r\n\t\t//endregion\r\n\t}\r\n\t//**********************************************************************************\r\n\t/**\r\n\t * Convert current object to asn1js object and set correct values\r\n\t * @returns {Object} asn1js object\r\n\t */\r\n\ttoSchema(encodeFlag = false)\r\n\t{\r\n\t\t//region Create array for output sequence\r\n\t\tconst outputArray = [];\r\n\t\t\r\n\t\toutputArray.push(new asn1js.Integer({ value: this.version }));\r\n\t\t\r\n\t\t//region Create array of digest algorithms\r\n\t\toutputArray.push(new asn1js.Set({\r\n\t\t\tvalue: Array.from(this.digestAlgorithms, algorithm => algorithm.toSchema(encodeFlag))\r\n\t\t}));\r\n\t\t//endregion\r\n\t\t\r\n\t\toutputArray.push(this.encapContentInfo.toSchema());\r\n\t\t\r\n\t\tif(\"certificates\" in this)\r\n\t\t{\r\n\t\t\tconst certificateSet = new CertificateSet({ certificates: this.certificates });\r\n\t\t\tconst certificateSetSchema = certificateSet.toSchema();\r\n\t\t\t\r\n\t\t\toutputArray.push(new asn1js.Constructed({\r\n\t\t\t\tidBlock: {\r\n\t\t\t\t\ttagClass: 3,\r\n\t\t\t\t\ttagNumber: 0\r\n\t\t\t\t},\r\n\t\t\t\tvalue: certificateSetSchema.valueBlock.value\r\n\t\t\t}));\r\n\t\t}\r\n\t\t\r\n\t\tif(\"crls\" in this)\r\n\t\t{\r\n\t\t\toutputArray.push(new asn1js.Constructed({\r\n\t\t\t\tidBlock: {\r\n\t\t\t\t\ttagClass: 3, // CONTEXT-SPECIFIC\r\n\t\t\t\t\ttagNumber: 1 // [1]\r\n\t\t\t\t},\r\n\t\t\t\tvalue: Array.from(this.crls, crl =>\r\n\t\t\t\t{\r\n\t\t\t\t\tif(crl instanceof OtherRevocationInfoFormat)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tconst crlSchema = crl.toSchema(encodeFlag);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcrlSchema.idBlock.tagClass = 3;\r\n\t\t\t\t\t\tcrlSchema.idBlock.tagNumber = 1;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\treturn crlSchema;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\treturn crl.toSchema(encodeFlag);\r\n\t\t\t\t})\r\n\t\t\t}));\r\n\t\t}\r\n\t\t\r\n\t\t//region Create array of signer infos\r\n\t\toutputArray.push(new asn1js.Set({\r\n\t\t\tvalue: Array.from(this.signerInfos, signerInfo => signerInfo.toSchema(encodeFlag))\r\n\t\t}));\r\n\t\t//endregion\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region Construct and return new ASN.1 schema for this object\r\n\t\treturn (new asn1js.Sequence({\r\n\t\t\tvalue: outputArray\r\n\t\t}));\r\n\t\t//endregion\r\n\t}\r\n\t//**********************************************************************************\r\n\t/**\r\n\t * Convertion for the class to JSON object\r\n\t * @returns {Object}\r\n\t */\r\n\ttoJSON()\r\n\t{\r\n\t\tconst _object = {\r\n\t\t\tversion: this.version,\r\n\t\t\tdigestAlgorithms: Array.from(this.digestAlgorithms, algorithm => algorithm.toJSON()),\r\n\t\t\tencapContentInfo: this.encapContentInfo.toJSON()\r\n\t\t};\r\n\t\t\r\n\t\tif(\"certificates\" in this)\r\n\t\t\t_object.certificates = Array.from(this.certificates, certificate => certificate.toJSON());\r\n\t\t\r\n\t\tif(\"crls\" in this)\r\n\t\t\t_object.crls = Array.from(this.crls, crl => crl.toJSON());\r\n\t\t\r\n\t\t_object.signerInfos = Array.from(this.signerInfos, signerInfo => signerInfo.toJSON());\r\n\t\t\r\n\t\treturn _object;\r\n\t}\r\n\t//**********************************************************************************\r\n\t/**\r\n\t * Verify current SignedData value\r\n\t * @param signer\r\n\t * @param data\r\n\t * @param trustedCerts\r\n\t * @param checkDate\r\n\t * @param checkChain\r\n\t * @param includeSignerCertificate\r\n\t * @param extendedMode\r\n\t * @param findOrigin\r\n\t * @param findIssuer\r\n\t * @returns {*}\r\n\t */\r\n\tverify({\r\n\t\tsigner = (-1),\r\n\t\tdata = (new ArrayBuffer(0)),\r\n\t\ttrustedCerts = [],\r\n\t\tcheckDate = (new Date()),\r\n\t\tcheckChain = false,\r\n\t\textendedMode = false,\r\n\t\tfindOrigin = null,\r\n\t\tfindIssuer = null\r\n\t} = {})\r\n\t{\r\n\t\t//region Global variables\r\n\t\tlet sequence = Promise.resolve();\r\n\t\t\r\n\t\tlet messageDigestValue = new ArrayBuffer(0);\r\n\t\t\r\n\t\tlet shaAlgorithm = \"\";\r\n\t\t\r\n\t\tlet signerCertificate = {};\r\n\t\t\r\n\t\tlet timestampSerial = null;\r\n\t\t\r\n\t\tlet certificatePath = [];\r\n\t\t\r\n\t\tconst engine = getEngine();\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region Get a \"crypto\" extension\r\n\t\tconst crypto = getCrypto();\r\n\t\tif(typeof crypto === \"undefined\")\r\n\t\t\treturn Promise.reject(\"Unable to create WebCrypto object\");\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region Get a signer number\r\n\t\tif(signer === (-1))\r\n\t\t{\r\n\t\t\tif(extendedMode)\r\n\t\t\t{\r\n\t\t\t\treturn Promise.reject({\r\n\t\t\t\t\tdate: checkDate,\r\n\t\t\t\t\tcode: 1,\r\n\t\t\t\t\tmessage: \"Unable to get signer index from input parameters\",\r\n\t\t\t\t\tsignatureVerified: null,\r\n\t\t\t\t\tsignerCertificate: null,\r\n\t\t\t\t\tsignerCertificateVerified: null\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\treturn Promise.reject(\"Unable to get signer index from input parameters\");\r\n\t\t}\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region Check that certificates field was included in signed data\r\n\t\tif((\"certificates\" in this) === false)\r\n\t\t{\r\n\t\t\tif(extendedMode)\r\n\t\t\t{\r\n\t\t\t\treturn Promise.reject({\r\n\t\t\t\t\tdate: checkDate,\r\n\t\t\t\t\tcode: 2,\r\n\t\t\t\t\tmessage: \"No certificates attached to this signed data\",\r\n\t\t\t\t\tsignatureVerified: null,\r\n\t\t\t\t\tsignerCertificate: null,\r\n\t\t\t\t\tsignerCertificateVerified: null\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\treturn Promise.reject(\"No certificates attached to this signed data\");\r\n\t\t}\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region Find a certificate for specified signer\r\n\t\tif(this.signerInfos[signer].sid instanceof IssuerAndSerialNumber)\r\n\t\t{\r\n\t\t\tsequence = sequence.then(() =>\r\n\t\t\t{\r\n\t\t\t\tfor(const certificate of this.certificates)\r\n\t\t\t\t{\r\n\t\t\t\t\tif((certificate instanceof Certificate) === false)\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t\r\n\t\t\t\t\tif((certificate.issuer.isEqual(this.signerInfos[signer].sid.issuer)) &&\r\n\t\t\t\t\t\t(certificate.serialNumber.isEqual(this.signerInfos[signer].sid.serialNumber)))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tsignerCertificate = certificate;\r\n\t\t\t\t\t\treturn Promise.resolve();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif(extendedMode)\r\n\t\t\t\t{\r\n\t\t\t\t\treturn Promise.reject({\r\n\t\t\t\t\t\tdate: checkDate,\r\n\t\t\t\t\t\tcode: 3,\r\n\t\t\t\t\t\tmessage: \"Unable to find signer certificate\",\r\n\t\t\t\t\t\tsignatureVerified: null,\r\n\t\t\t\t\t\tsignerCertificate: null,\r\n\t\t\t\t\t\tsignerCertificateVerified: null\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\treturn Promise.reject(\"Unable to find signer certificate\");\r\n\t\t\t});\r\n\t\t}\r\n\t\telse // Find by SubjectKeyIdentifier\r\n\t\t{\r\n\t\t\tsequence = sequence.then(() =>\r\n\t\t\t\tPromise.all(Array.from(this.certificates.filter(certificate => (certificate instanceof Certificate)), certificate =>\r\n\t\t\t\t\tcrypto.digest({ name: \"sha-1\" }, new Uint8Array(certificate.subjectPublicKeyInfo.subjectPublicKey.valueBlock.valueHex)))\r\n\t\t\t\t).then(results =>\r\n\t\t\t\t{\r\n\t\t\t\t\tfor(const [index, certificate] of this.certificates.entries())\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif((certificate instanceof Certificate) === false)\r\n\t\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tif(isEqualBuffer(results[index], this.signerInfos[signer].sid.valueBlock.valueHex))\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tsignerCertificate = certificate;\r\n\t\t\t\t\t\t\treturn Promise.resolve();\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(extendedMode)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\treturn Promise.reject({\r\n\t\t\t\t\t\t\tdate: checkDate,\r\n\t\t\t\t\t\t\tcode: 3,\r\n\t\t\t\t\t\t\tmessage: \"Unable to find signer certificate\",\r\n\t\t\t\t\t\t\tsignatureVerified: null,\r\n\t\t\t\t\t\t\tsignerCertificate: null,\r\n\t\t\t\t\t\t\tsignerCertificateVerified: null\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\treturn Promise.reject(\"Unable to find signer certificate\");\r\n\t\t\t\t}, () =>\r\n\t\t\t\t{\r\n\t\t\t\t\tif(extendedMode)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\treturn Promise.reject({\r\n\t\t\t\t\t\t\tdate: checkDate,\r\n\t\t\t\t\t\t\tcode: 3,\r\n\t\t\t\t\t\t\tmessage: \"Unable to find signer certificate\",\r\n\t\t\t\t\t\t\tsignatureVerified: null,\r\n\t\t\t\t\t\t\tsignerCertificate: null,\r\n\t\t\t\t\t\t\tsignerCertificateVerified: null\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\treturn Promise.reject(\"Unable to find signer certificate\");\r\n\t\t\t\t})\r\n\t\t\t);\r\n\t\t}\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region Verify internal digest in case of \"tSTInfo\" content type\r\n\t\tsequence = sequence.then(() =>\r\n\t\t{\r\n\t\t\tif(this.encapContentInfo.eContentType === \"1.2.840.113549.1.9.16.1.4\")\r\n\t\t\t{\r\n\t\t\t\t//region Check \"eContent\" precense\r\n\t\t\t\tif((\"eContent\" in this.encapContentInfo) === false)\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t//endregion\r\n\t\t\t\t\r\n\t\t\t\t//region Initialize TST_INFO value\r\n\t\t\t\tconst asn1 = asn1js.fromBER(this.encapContentInfo.eContent.valueBlock.valueHex);\r\n\t\t\t\tlet tstInfo;\r\n\t\t\t\t\r\n\t\t\t\ttry\r\n\t\t\t\t{\r\n\t\t\t\t\ttstInfo = new TSTInfo({ schema: asn1.result });\r\n\t\t\t\t}\r\n\t\t\t\tcatch(ex)\r\n\t\t\t\t{\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t\t//endregion\r\n\t\t\t\t\r\n\t\t\t\t//region Change \"checkDate\" and append \"timestampSerial\"\r\n\t\t\t\tcheckDate = tstInfo.genTime;\r\n\t\t\t\ttimestampSerial = tstInfo.serialNumber.valueBlock.valueHex;\r\n\t\t\t\t//endregion\r\n\t\t\t\t\r\n\t\t\t\t//region Check that we do have detached data content\r\n\t\t\t\tif(data.byteLength === 0)\r\n\t\t\t\t{\r\n\t\t\t\t\tif(extendedMode)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\treturn Promise.reject({\r\n\t\t\t\t\t\t\tdate: checkDate,\r\n\t\t\t\t\t\t\tcode: 4,\r\n\t\t\t\t\t\t\tmessage: \"Missed detached data input array\",\r\n\t\t\t\t\t\t\tsignatureVerified: null,\r\n\t\t\t\t\t\t\tsignerCertificate,\r\n\t\t\t\t\t\t\tsignerCertificateVerified: null\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\treturn Promise.reject(\"Missed detached data input array\");\r\n\t\t\t\t}\r\n\t\t\t\t//endregion\r\n\t\t\t\t\r\n\t\t\t\treturn tstInfo.verify({ data });\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\treturn true;\r\n\t\t});\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region Make additional verification for signer's certificate\r\n\t\tfunction checkCA(cert)\r\n\t\t{\r\n\t\t\t/// <param name=\"cert\" type=\"in_window.org.pkijs.simpl.CERT\">Certificate to find CA flag for</param>\r\n\t\t\t\r\n\t\t\t//region Do not include signer's certificate\r\n\t\t\tif((cert.issuer.isEqual(signerCertificate.issuer) === true) && (cert.serialNumber.isEqual(signerCertificate.serialNumber) === true))\r\n\t\t\t\treturn null;\r\n\t\t\t//endregion\r\n\t\t\t\r\n\t\t\tlet isCA = false;\r\n\t\t\t\r\n\t\t\tif(\"extensions\" in cert)\r\n\t\t\t{\r\n\t\t\t\tfor(const extension of cert.extensions)\r\n\t\t\t\t{\r\n\t\t\t\t\tif(extension.extnID === \"2.5.29.19\") // BasicConstraints\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif(\"cA\" in extension.parsedValue)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tif(extension.parsedValue.cA === true)\r\n\t\t\t\t\t\t\t\tisCA = true;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif(isCA)\r\n\t\t\t\treturn cert;\r\n\t\t\t\r\n\t\t\treturn null;\r\n\t\t}\r\n\t\t\r\n\t\tif(checkChain)\r\n\t\t{\r\n\t\t\tsequence = sequence.then(result =>\r\n\t\t\t{\r\n\t\t\t\t//region Verify result of previous operation\r\n\t\t\t\tif(result === false)\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t//endregion\r\n\t\t\t\t\r\n\t\t\t\tconst promiseResults = Array.from(this.certificates.filter(certificate => (certificate instanceof Certificate)), certificate => checkCA(certificate));\r\n\t\t\t\t\r\n\t\t\t\tconst certificateChainValidationEngineParameters = {\r\n\t\t\t\t\tcheckDate,\r\n\t\t\t\t\tcerts: Array.from(promiseResults.filter(_result => (_result !== null))),\r\n\t\t\t\t\ttrustedCerts\r\n\t\t\t\t};\r\n\t\t\t\t\r\n\t\t\t\tif(findIssuer !== null)\r\n\t\t\t\t\tcertificateChainValidationEngineParameters.findIssuer = findIssuer;\r\n\t\t\t\t\r\n\t\t\t\tif(findOrigin !== null)\r\n\t\t\t\t\tcertificateChainValidationEngineParameters.findOrigin = findOrigin;\r\n\t\t\t\t\r\n\t\t\t\tconst certificateChainEngine = new CertificateChainValidationEngine(certificateChainValidationEngineParameters);\r\n\t\t\t\t\r\n\t\t\t\tcertificateChainEngine.certs.push(signerCertificate);\r\n\t\t\t\t\r\n\t\t\t\tif(\"crls\" in this)\r\n\t\t\t\t{\r\n\t\t\t\t\tfor(const crl of this.crls)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif(crl instanceof CertificateRevocationList)\r\n\t\t\t\t\t\t\tcertificateChainEngine.crls.push(crl);\r\n\t\t\t\t\t\telse // Assumed \"revocation value\" has \"OtherRevocationInfoFormat\"\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tif(crl.otherRevInfoFormat === \"1.3.6.1.5.5.7.48.1.1\") // Basic OCSP response\r\n\t\t\t\t\t\t\t\tcertificateChainEngine.ocsps.push(new BasicOCSPResponse({ schema: crl.otherRevInfo }));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif(\"ocsps\" in this)\r\n\t\t\t\t\tcertificateChainEngine.ocsps.push(...(this.ocsps));\r\n\t\t\t\t\r\n\t\t\t\treturn certificateChainEngine.verify().then(verificationResult =>\r\n\t\t\t\t{\r\n\t\t\t\t\tif(\"certificatePath\" in verificationResult)\r\n\t\t\t\t\t\tcertificatePath = verificationResult.certificatePath;\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(verificationResult.result === true)\r\n\t\t\t\t\t\treturn Promise.resolve(true);\r\n\t\t\t\t\t\r\n\t\t\t\t\tif(extendedMode)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\treturn Promise.reject({\r\n\t\t\t\t\t\t\tdate: checkDate,\r\n\t\t\t\t\t\t\tcode: 5,\r\n\t\t\t\t\t\t\tmessage: `Validation of signer's certificate failed: ${verificationResult.resultMessage}`,\r\n\t\t\t\t\t\t\tsignatureVerified: null,\r\n\t\t\t\t\t\t\tsignerCertificate,\r\n\t\t\t\t\t\t\tsignerCertificateVerified: false\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\treturn Promise.reject(\"Validation of signer's certificate failed\");\r\n\t\t\t\t}, error =>\r\n\t\t\t\t{\r\n\t\t\t\t\tif(extendedMode)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\treturn Promise.reject({\r\n\t\t\t\t\t\t\tdate: checkDate,\r\n\t\t\t\t\t\t\tcode: 5,\r\n\t\t\t\t\t\t\tmessage: `Validation of signer's certificate failed with error: ${((error instanceof Object) ? error.resultMessage : error)}`,\r\n\t\t\t\t\t\t\tsignatureVerified: null,\r\n\t\t\t\t\t\t\tsignerCertificate,\r\n\t\t\t\t\t\t\tsignerCertificateVerified: false\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\treturn Promise.reject(`Validation of signer's certificate failed with error: ${((error instanceof Object) ? error.resultMessage : error)}`);\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region Find signer's hashing algorithm\r\n\t\tsequence = sequence.then(result =>\r\n\t\t{\r\n\t\t\t//region Verify result of previous operation\r\n\t\t\tif(result === false)\r\n\t\t\t\treturn false;\r\n\t\t\t//endregion\r\n\t\t\t\r\n\t\t\tconst signerInfoHashAlgorithm = getAlgorithmByOID(this.signerInfos[signer].digestAlgorithm.algorithmId);\r\n\t\t\tif((\"name\" in signerInfoHashAlgorithm) === false)\r\n\t\t\t{\r\n\t\t\t\tif(extendedMode)\r\n\t\t\t\t{\r\n\t\t\t\t\treturn Promise.reject({\r\n\t\t\t\t\t\tdate: checkDate,\r\n\t\t\t\t\t\tcode: 7,\r\n\t\t\t\t\t\tmessage: `Unsupported signature algorithm: ${this.signerInfos[signer].digestAlgorithm.algorithmId}`,\r\n\t\t\t\t\t\tsignatureVerified: null,\r\n\t\t\t\t\t\tsignerCertificate,\r\n\t\t\t\t\t\tsignerCertificateVerified: true\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\treturn Promise.reject(`Unsupported signature algorithm: ${this.signerInfos[signer].digestAlgorithm.algorithmId}`);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tshaAlgorithm = signerInfoHashAlgorithm.name;\r\n\t\t\t\r\n\t\t\treturn true;\r\n\t\t});\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region Create correct data block for verification\r\n\t\tsequence = sequence.then(result =>\r\n\t\t{\r\n\t\t\t//region Verify result of previous operation\r\n\t\t\tif(result === false)\r\n\t\t\t\treturn false;\r\n\t\t\t//endregion\r\n\t\t\t\r\n\t\t\tif(\"eContent\" in this.encapContentInfo) // Attached data\r\n\t\t\t{\r\n\t\t\t\tif((this.encapContentInfo.eContent.idBlock.tagClass === 1) &&\r\n\t\t\t\t\t(this.encapContentInfo.eContent.idBlock.tagNumber === 4))\r\n\t\t\t\t{\r\n\t\t\t\t\tif(this.encapContentInfo.eContent.idBlock.isConstructed === false)\r\n\t\t\t\t\t\tdata = this.encapContentInfo.eContent.valueBlock.valueHex;\r\n\t\t\t\t\telse\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tfor(const contentValue of this.encapContentInfo.eContent.valueBlock.value)\r\n\t\t\t\t\t\t\tdata = utilConcatBuf(data, contentValue.valueBlock.valueHex);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse\r\n\t\t\t\t\tdata = this.encapContentInfo.eContent.valueBlock.valueBeforeDecode;\r\n\t\t\t}\r\n\t\t\telse // Detached data\r\n\t\t\t{\r\n\t\t\t\tif(data.byteLength === 0) // Check that \"data\" already provided by function parameter\r\n\t\t\t\t{\r\n\t\t\t\t\tif(extendedMode)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\treturn Promise.reject({\r\n\t\t\t\t\t\t\tdate: checkDate,\r\n\t\t\t\t\t\t\tcode: 8,\r\n\t\t\t\t\t\t\tmessage: \"Missed detached data input array\",\r\n\t\t\t\t\t\t\tsignatureVerified: null,\r\n\t\t\t\t\t\t\tsignerCertificate,\r\n\t\t\t\t\t\t\tsignerCertificateVerified: true\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\treturn Promise.reject(\"Missed detached data input array\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\tif(\"signedAttrs\" in this.signerInfos[signer])\r\n\t\t\t{\r\n\t\t\t\t//region Check mandatory attributes\r\n\t\t\t\tlet foundContentType = false;\r\n\t\t\t\tlet foundMessageDigest = false;\r\n\t\t\t\t\r\n\t\t\t\tfor(const attribute of this.signerInfos[signer].signedAttrs.attributes)\r\n\t\t\t\t{\r\n\t\t\t\t\t//region Check that \"content-type\" attribute exists\r\n\t\t\t\t\tif(attribute.type === \"1.2.840.113549.1.9.3\")\r\n\t\t\t\t\t\tfoundContentType = true;\r\n\t\t\t\t\t//endregion\r\n\t\t\t\t\t\r\n\t\t\t\t\t//region Check that \"message-digest\" attribute exists\r\n\t\t\t\t\tif(attribute.type === \"1.2.840.113549.1.9.4\")\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tfoundMessageDigest = true;\r\n\t\t\t\t\t\tmessageDigestValue = attribute.values[0].valueBlock.valueHex;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t//endregion\r\n\t\t\t\t\t\r\n\t\t\t\t\t//region Speed-up searching\r\n\t\t\t\t\tif(foundContentType && foundMessageDigest)\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t//endregion\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif(foundContentType === false)\r\n\t\t\t\t{\r\n\t\t\t\t\tif(extendedMode)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\treturn Promise.reject({\r\n\t\t\t\t\t\t\tdate: checkDate,\r\n\t\t\t\t\t\t\tcode: 9,\r\n\t\t\t\t\t\t\tmessage: \"Attribute \\\"content-type\\\" is a mandatory attribute for \\\"signed attributes\\\"\",\r\n\t\t\t\t\t\t\tsignatureVerified: null,\r\n\t\t\t\t\t\t\tsignerCertificate,\r\n\t\t\t\t\t\t\tsignerCertificateVerified: true\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\treturn Promise.reject(\"Attribute \\\"content-type\\\" is a mandatory attribute for \\\"signed attributes\\\"\");\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tif(foundMessageDigest === false)\r\n\t\t\t\t{\r\n\t\t\t\t\tif(extendedMode)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\treturn Promise.reject({\r\n\t\t\t\t\t\t\tdate: checkDate,\r\n\t\t\t\t\t\t\tcode: 10,\r\n\t\t\t\t\t\t\tmessage: \"Attribute \\\"message-digest\\\" is a mandatory attribute for \\\"signed attributes\\\"\",\r\n\t\t\t\t\t\t\tsignatureVerified: null,\r\n\t\t\t\t\t\t\tsignerCertificate,\r\n\t\t\t\t\t\t\tsignerCertificateVerified: true\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\treturn Promise.reject(\"Attribute \\\"message-digest\\\" is a mandatory attribute for \\\"signed attributes\\\"\");\r\n\t\t\t\t}\r\n\t\t\t\t//endregion\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\treturn true;\r\n\t\t});\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region Verify \"message-digest\" attribute in case of \"signedAttrs\"\r\n\t\tsequence = sequence.then(result =>\r\n\t\t{\r\n\t\t\t//region Verify result of previous operation\r\n\t\t\tif(result === false)\r\n\t\t\t\treturn false;\r\n\t\t\t//endregion\r\n\t\t\t\r\n\t\t\tif(\"signedAttrs\" in this.signerInfos[signer])\r\n\t\t\t\treturn crypto.digest(shaAlgorithm, new Uint8Array(data));\r\n\t\t\t\r\n\t\t\treturn true;\r\n\t\t}).then(\r\n\t\t\t/**\r\n\t\t\t * @param {ArrayBuffer} result\r\n\t\t\t */\r\n\t\t\tresult =>\r\n\t\t\t{\r\n\t\t\t\t//region Verify result of previous operation\r\n\t\t\t\tif(result === false)\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t//endregion\r\n\t\t\t\t\r\n\t\t\t\tif(\"signedAttrs\" in this.signerInfos[signer])\r\n\t\t\t\t{\r\n\t\t\t\t\tif(isEqualBuffer(result, messageDigestValue))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tdata = this.signerInfos[signer].signedAttrs.encodedValue;\r\n\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\treturn true;\r\n\t\t\t});\r\n\t\t//endregion\r\n\t\t\r\n\t\tsequence = sequence.then(result =>\r\n\t\t{\r\n\t\t\t//region Verify result of previous operation\r\n\t\t\tif(result === false)\r\n\t\t\t\treturn false;\r\n\t\t\t//endregion\r\n\t\t\t\r\n\t\t\treturn engine.subtle.verifyWithPublicKey(data, this.signerInfos[signer].signature, signerCertificate.subjectPublicKeyInfo, signerCertificate.signatureAlgorithm, shaAlgorithm);\r\n\t\t});\r\n\t\t\r\n\t\t//region Make a final result\r\n\t\tsequence = sequence.then(result =>\r\n\t\t{\r\n\t\t\tif(extendedMode)\r\n\t\t\t{\r\n\t\t\t\treturn {\r\n\t\t\t\t\tdate: checkDate,\r\n\t\t\t\t\tcode: 14,\r\n\t\t\t\t\tmessage: \"\",\r\n\t\t\t\t\tsignatureVerified: result,\r\n\t\t\t\t\tsignerCertificate,\r\n\t\t\t\t\ttimestampSerial,\r\n\t\t\t\t\tsignerCertificateVerified: true,\r\n\t\t\t\t\tcertificatePath\r\n\t\t\t\t};\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\treturn result;\r\n\t\t}, error =>\r\n\t\t{\r\n\t\t\tif(extendedMode)\r\n\t\t\t{\r\n\t\t\t\tif(\"code\" in error)\r\n\t\t\t\t\treturn Promise.reject(error);\r\n\t\t\t\t\r\n\t\t\t\treturn Promise.reject({\r\n\t\t\t\t\tdate: checkDate,\r\n\t\t\t\t\tcode: 15,\r\n\t\t\t\t\tmessage: `Error during verification: ${error.message}`,\r\n\t\t\t\t\tsignatureVerified: null,\r\n\t\t\t\t\tsignerCertificate,\r\n\t\t\t\t\ttimestampSerial,\r\n\t\t\t\t\tsignerCertificateVerified: true\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\treturn Promise.reject(error);\r\n\t\t});\r\n\t\t//endregion\r\n\t\t\r\n\t\treturn sequence;\r\n\t}\r\n\t//**********************************************************************************\r\n\t/**\r\n\t * Signing current SignedData\r\n\t * @param {key} privateKey Private key for \"subjectPublicKeyInfo\" structure\r\n\t * @param {number} signerIndex Index number (starting from 0) of signer index to make signature for\r\n\t * @param {string} [hashAlgorithm=\"SHA-1\"] Hashing algorithm. Default SHA-1\r\n\t * @param {ArrayBuffer} [data] Detached data\r\n\t * @returns {*}\r\n\t */\r\n\tsign(privateKey, signerIndex, hashAlgorithm = \"SHA-1\", data = (new ArrayBuffer(0)))\r\n\t{\r\n\t\t//region Initial checking\r\n\t\tif(typeof privateKey === \"undefined\")\r\n\t\t\treturn Promise.reject(\"Need to provide a private key for signing\");\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region Initial variables\r\n\t\tlet sequence = Promise.resolve();\r\n\t\tlet parameters;\r\n\t\t\r\n\t\tconst engine = getEngine();\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region Simple check for supported algorithm\r\n\t\tconst hashAlgorithmOID = getOIDByAlgorithm({ name: hashAlgorithm });\r\n\t\tif(hashAlgorithmOID === \"\")\r\n\t\t\treturn Promise.reject(`Unsupported hash algorithm: ${hashAlgorithm}`);\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region Append information about hash algorithm\r\n\t\tif((this.digestAlgorithms.filter(algorithm => algorithm.algorithmId === hashAlgorithmOID)).length === 0)\r\n\t\t{\r\n\t\t\tthis.digestAlgorithms.push(new AlgorithmIdentifier({\r\n\t\t\t\talgorithmId: hashAlgorithmOID,\r\n\t\t\t\talgorithmParams: new asn1js.Null()\r\n\t\t\t}));\r\n\t\t}\r\n\t\t\r\n\t\tthis.signerInfos[signerIndex].digestAlgorithm = new AlgorithmIdentifier({\r\n\t\t\talgorithmId: hashAlgorithmOID,\r\n\t\t\talgorithmParams: new asn1js.Null()\r\n\t\t});\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region Get a \"default parameters\" for current algorithm and set correct signature algorithm\r\n\t\tsequence = sequence.then(() => engine.subtle.getSignatureParameters(privateKey, hashAlgorithm));\r\n\t\t\r\n\t\tsequence = sequence.then(result =>\r\n\t\t{\r\n\t\t\tparameters = result.parameters;\r\n\t\t\tthis.signerInfos[signerIndex].signatureAlgorithm = result.signatureAlgorithm;\r\n\t\t});\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region Create TBS data for signing\r\n\t\tsequence = sequence.then(() =>\r\n\t\t{\r\n\t\t\tif(\"signedAttrs\" in this.signerInfos[signerIndex])\r\n\t\t\t{\r\n\t\t\t\tif(this.signerInfos[signerIndex].signedAttrs.encodedValue.byteLength !== 0)\r\n\t\t\t\t\tdata = this.signerInfos[signerIndex].signedAttrs.encodedValue;\r\n\t\t\t\telse\r\n\t\t\t\t{\r\n\t\t\t\t\tdata = this.signerInfos[signerIndex].signedAttrs.toSchema(true).toBER(false);\r\n\t\t\t\t\t\r\n\t\t\t\t\t//region Change type from \"[0]\" to \"SET\" acordingly to standard\r\n\t\t\t\t\tconst view = new Uint8Array(data);\r\n\t\t\t\t\tview[0] = 0x31;\r\n\t\t\t\t\t//endregion\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tif(\"eContent\" in this.encapContentInfo) // Attached data\r\n\t\t\t\t{\r\n\t\t\t\t\tif((this.encapContentInfo.eContent.idBlock.tagClass === 1) &&\r\n\t\t\t\t\t\t(this.encapContentInfo.eContent.idBlock.tagNumber === 4))\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tif(this.encapContentInfo.eContent.idBlock.isConstructed === false)\r\n\t\t\t\t\t\t\tdata = this.encapContentInfo.eContent.valueBlock.valueHex;\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tfor(const content of this.encapContentInfo.eContent.valueBlock.value)\r\n\t\t\t\t\t\t\t\tdata = utilConcatBuf(data, content.valueBlock.valueHex);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tdata = this.encapContentInfo.eContent.valueBlock.valueBeforeDecode;\r\n\t\t\t\t}\r\n\t\t\t\telse // Detached data\r\n\t\t\t\t{\r\n\t\t\t\t\tif(data.byteLength === 0) // Check that \"data\" already provided by function parameter\r\n\t\t\t\t\t\treturn Promise.reject(\"Missed detached data input array\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\treturn Promise.resolve();\r\n\t\t});\r\n\t\t//endregion\r\n\t\t\r\n\t\t//region Signing TBS data on provided private key\r\n\t\tsequence = sequence.then(() => engine.subtle.signWithPrivateKey(data, privateKey, parameters));\r\n\t\t\r\n\t\tsequence = sequence.then(result =>\r\n\t\t{\r\n\t\t\tthis.signerInfos[signerIndex].signature = new asn1js.OctetString({ valueHex: result });\r\n\t\t\t\r\n\t\t\treturn result;\r\n\t\t});\r\n\t\t//endregion\r\n\t\t\r\n\t\treturn sequence;\r\n\t}\r\n\t//**********************************************************************************\r\n}\r\n//**************************************************************************************\r\n"]}